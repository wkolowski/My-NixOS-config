# My NixOS setup

This is the full setup process for my NixOS virtual machine (and soon also my desktop).
It's based on [this post of Chris Martin](chris-martin.org/2015/installing-nixos).

## Disk setup

Use `gparted` (or `fdisk`) to get something like this:

| Name      | Mounted | Size |
| --------- | ------- | ---- |
| /dev/sda1 | /boot   | 500M |
| /dev/sda2 | /       | rest |

Setup disk encyprtion using LUKS:

```bash
sudo cryptsetup luksFormat /dev/sda2
sudo cryptsetup luksOpen /dev/sda2 sda2_crypt
```
Create LVM groups and volumes:

```bash
sudo pvcreate /dev/mapper/sda2_crypt

sudo vgcreate vg /dev/mapper/sda2_crypt

sudo lvcreate -n swap vg -L 8G
sudo lvcreate -n root vg -l 100%FREE
```

Make new filesystems and swap:

```bash
sudo mkfs.vfat -n BOOT /dev/sda1
sudo mkfs.btrfs -L root /dev/vg/root
sudo mkswap -L swap /dev/vg/swap
```

## Installation

Mount everything and activate the swap:

```bash
sudo mount /dev/vg/root /mnt

sudo mkdir /mnt/boot
sudo mount /dev/sda1 /mnt/boot

sudo swapon /dev/vg/swap
```

Generate nix configuration for hardware and overwrite the autogenerated config with the one from this repo:

```bash
sudo nixos-generate-config --root /mnt
sudo curl https://raw.githubusercontent.com/wkolowski/nixos-config/master/configuration.nix > tmp
sudo mv tmp /mnt/etc/nixos/configuration.nix
```

Finish the installation:

```bash
nixos-install
```

## Configuration

Set a password for myself:

```bash
passwd wk
```

Set up git credentials:
```bash
git config --global user.name <name>
git config --global user.email <mail>
```
